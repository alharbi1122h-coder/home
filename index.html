<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¨Ù†Ø§Ø¡</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg1:#111827; --bg2:#1f2937;
  --card:#ffffff22; --border:#ffffff33;
  --text:#f9fafb; --muted:#cbd5e1;
  --primary:#60a5fa; --primary2:#3b82f6;
  --danger:#ef4444;
  --radius:18px;
}
.light{
  --bg1:#f8fafc; --bg2:#e5e7eb;
  --card:#00000010; --border:#00000022;
  --text:#0f172a; --muted:#475569;
}

*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,Tahoma,Arial;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  color:var(--text);
}
.container{max-width:1200px;margin:auto;padding:18px}
.layout{display:grid;gap:16px}
@media(min-width:980px){.layout{grid-template-columns:360px 1fr}}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
  backdrop-filter:blur(12px);
}

/* Accordion (iOS style) */
.accordion .card-header{
  display:flex;justify-content:space-between;
  cursor:pointer;align-items:flex-start;
}
.arrow{transition:.25s}
.accordion.open .arrow{transform:rotate(180deg)}
.accordion-content{
  max-height:0;overflow:hidden;opacity:0;
  transition:.35s;
}
.accordion.open .accordion-content{
  max-height:10000px;opacity:1;
}

/* UI */
.card-title{font-weight:900;font-size:16px}
.card-desc{font-size:12px;color:var(--muted)}
.hr{height:1px;background:var(--border);margin:14px 0}
.input,select,textarea{
  width:100%;padding:14px;border-radius:14px;
  border:1px solid var(--border);
  background:transparent;color:var(--text);
}
textarea{min-height:120px}
.label{font-size:12px;font-weight:800;margin:8px 0 6px}

.btn{
  padding:12px 14px;border:none;border-radius:14px;
  font-weight:800;cursor:pointer;
  background:linear-gradient(135deg,var(--primary),var(--primary2));
  color:#fff;
}
.btn.secondary{background:transparent;border:1px solid var(--border)}
.btn.danger{background:linear-gradient(135deg,#ef4444,#b91c1c)}
.btn.sm{padding:10px;font-size:13px}

/* Focus Mode */
.focus .accordion:not(#secAddEdit){display:none}

/* Stats */
.stat{
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
  background:rgba(255,255,255,.08);
}
.stat .k{font-size:12px;color:var(--muted);font-weight:800}
.stat .v{font-size:22px;font-weight:900}

/* Expenses */
.expense{
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
  margin-bottom:10px;
  background:rgba(255,255,255,.08);
}
.expense .top{
  display:flex;justify-content:space-between;
  font-weight:900;
}
.meta{font-size:12px;color:var(--muted);margin-top:4px}
.actions{display:flex;gap:8px;margin-top:8px}
.actions .btn{flex:1}

/* Bigger project notes */
#projectNotes{
  font-size:17px;
  line-height:1.8;
}
</style>
</head>

<body>
<div class="container">

<!-- ACTION BAR -->
<div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap">
  <button class="btn sm secondary" onclick="toggleTheme()">ğŸŒ— Ù†Ù‡Ø§Ø± / Ù„ÙŠÙ„</button>
  <button class="btn sm secondary" onclick="toggleFocus()">ğŸ‘ï¸â€ğŸ—¨ï¸ ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ²</button>
  <button class="btn sm" onclick="exportBackup()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Excel</button>
</div>

<div class="layout">

<!-- SIDEBAR -->
<div>

<div class="card accordion" id="secNotes">
  <div class="card-header" onclick="toggleAccordion('secNotes')">
    <div>
      <div class="card-title">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
      <div class="card-desc">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©</div>
    </div><div class="arrow">â¬‡ï¸</div>
  </div>
  <div class="accordion-content">
    <textarea id="projectNotes" class="input"></textarea>
    <button class="btn sm" onclick="saveNotes()">ğŸ’¾ Ø­ÙØ¸</button>
  </div>
</div>

<div style="height:12px"></div>

<div class="card accordion" id="secCats">
  <div class="card-header" onclick="toggleAccordion('secCats')">
    <div>
      <div class="card-title">ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯</div>
      <div class="card-desc">Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø°Ù Ø§Ù„Ø¨Ù†ÙˆØ¯</div>
    </div><div class="arrow">â¬‡ï¸</div>
  </div>
  <div class="accordion-content">
    <input id="newCategoryName" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯">
    <button class="btn sm" onclick="addCategory()">â• Ø¥Ø¶Ø§ÙØ©</button>
    <div class="hr"></div>
    <div id="categoriesList"></div>
  </div>
</div>

</div>

<!-- MAIN -->
<div>

<!-- Stats -->
<div class="card accordion" id="secStats">
  <div class="card-header" onclick="toggleAccordion('secStats')">
    <div>
      <div class="card-title">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</div>
      <div class="card-desc">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ + Ù…Ø¬Ù…ÙˆØ¹ ÙƒÙ„ Ø¨Ù†Ø¯</div>
    </div><div class="arrow">â¬‡ï¸</div>
  </div>
  <div class="accordion-content">
    <div class="stat">
      <div class="k">ğŸ’° Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</div>
      <div class="v" id="totalAll">0 Ø±ÙŠØ§Ù„</div>
    </div>
    <div class="hr"></div>
    <div id="perCategory"></div>
  </div>
</div>

<div style="height:12px"></div>

<!-- ğŸ†• Category Details -->
<div class="card accordion" id="secCategoryDetails">
  <div class="card-header" onclick="toggleAccordion('secCategoryDetails')">
    <div>
      <div class="card-title">ğŸ“‚ ØªÙØ§ØµÙŠÙ„ Ù…ØµØ§Ø±ÙŠÙ Ø¨Ù†Ø¯</div>
      <div class="card-desc">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ù…ØµØ§Ø±ÙŠÙ Ø¨Ù†Ø¯ Ù…Ø¹ÙŠÙ‘Ù† Ù…Ø¹ Ù…Ø¬Ù…ÙˆØ¹Ù‡</div>
    </div><div class="arrow">â¬‡ï¸</div>
  </div>

  <div class="accordion-content">
    <label class="label">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ø¯</label>
    <select id="categoryDetailsSelect" class="input" onchange="renderCategoryDetails()">
      <option value="">â€” Ø§Ø®ØªØ± Ø¨Ù†Ø¯ â€”</option>
    </select>

    <div class="hr"></div>

    <div id="categoryTotal" class="stat" style="display:none;margin-bottom:10px">
      <div class="k">ğŸ’° Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯</div>
      <div class="v" id="categoryTotalValue">0 Ø±ÙŠØ§Ù„</div>
    </div>

    <div id="categoryExpensesList"></div>
  </div>
</div>

<div style="height:12px"></div>

<!-- Add/Edit -->
<div class="card accordion open" id="secAddEdit">
  <div class="card-header" onclick="toggleAccordion('secAddEdit')">
    <div>
      <div class="card-title">â• Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…ØµØ±ÙˆÙ</div>
      <div class="card-desc">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</div>
    </div><div class="arrow">â¬‡ï¸</div>
  </div>

  <div class="accordion-content">
    <form id="expenseForm">
      <label class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
      <input type="date" id="date" class="input">

      <label class="label">Ø§Ù„Ø¨Ù†Ø¯</label>
      <select id="categorySelect" class="input"></select>

      <label class="label">Ø§Ù„Ù…Ø¨Ù„Øº</label>
      <input type="number" id="amount" class="input">

      <label class="label">Ø§Ù„Ù…ÙˆØ±Ø¯</label>
      <input type="text" id="vendor" class="input">

      <label class="label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
      <textarea id="description" class="input"></textarea>

      <button class="btn sm">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
    </form>
  </div>
</div>

<div style="height:12px"></div>

<!-- Expenses -->
<div class="card accordion" id="secExpenses">
  <div class="card-header" onclick="toggleAccordion('secExpenses')">
    <div>
      <div class="card-title">ğŸ“‹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
      <div class="card-desc">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
    </div><div class="arrow">â¬‡ï¸</div>
  </div>
  <div class="accordion-content">
    <div id="expensesList"></div>
  </div>
</div>

</div>
</div>
</div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://iuqbkqxyjendpgtlvwem.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1cWJrcXh5amVuZHBndGx2d2VtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MjYyOTUsImV4cCI6MjA4MDQwMjI5NX0.puUnNqutG0IuyRwJ3m8d2g4i4RkSn4kJZODCu41aBBw"
);

let cache=[], editingId=null;

/* Accordion iOS */
function toggleAccordion(id){
  document.querySelectorAll(".accordion").forEach(a=>{
    if(a.id!==id) a.classList.remove("open");
  });
  document.getElementById(id).classList.toggle("open");
  localStorage.setItem("openSection",id);
}

/* Theme / Focus */
function toggleTheme(){
  document.body.classList.toggle("light");
  localStorage.setItem("theme",
    document.body.classList.contains("light")?"light":"dark");
}
function toggleFocus(){
  document.body.classList.toggle("focus");
}

/* Helpers */
date.value=new Date().toISOString().split("T")[0];

/* Notes */
async function saveNotes(){
  await sb.from("project_notes").upsert({id:1,notes:projectNotes.value});
}
async function loadNotes(){
  const {data}=await sb.from("project_notes").select("*").single();
  if(data) projectNotes.value=data.notes||"";
}

/* Categories */
async function loadCategories(){
  const {data}=await sb.from("categories").select("*").order("name");

  categorySelect.innerHTML="";
  categoriesList.innerHTML="";
  categoryDetailsSelect.innerHTML =
    `<option value="">â€” Ø§Ø®ØªØ± Ø¨Ù†Ø¯ â€”</option>`;

  data.forEach(c=>{
    categorySelect.add(new Option(c.name,c.id));
    categoryDetailsSelect.innerHTML +=
      `<option value="${c.id}">${c.name}</option>`;
    categoriesList.innerHTML+=`<div>${c.name}</div>`;
  });
}
async function addCategory(){
  if(!newCategoryName.value) return;
  await sb.from("categories").insert({name:newCategoryName.value});
  newCategoryName.value="";
  loadCategories();
}

/* Expenses */
async function loadExpenses(){
  const {data}=await sb.from("expenses")
    .select("*,categories(name)")
    .order("expense_date",{ascending:false});
  cache=data||[];
  renderStats();
  renderExpenses();
  renderCategoryDetails(); // ØªØ­Ø¯ÙŠØ« Ù„Ùˆ ÙƒØ§Ù† Ø¨Ù†Ø¯ Ù…Ø®ØªØ§Ø±
}

function renderStats(){
  let total=0, per={};
  cache.forEach(e=>{
    total+=Number(e.amount||0);
    const c=e.categories?.name||"ØºÙŠØ± Ù…ØµÙ†Ù";
    per[c]=(per[c]||0)+Number(e.amount||0);
  });
  totalAll.textContent=total.toLocaleString("ar-SA")+" Ø±ÙŠØ§Ù„";

  perCategory.innerHTML="";
  Object.entries(per).forEach(([k,v])=>{
    perCategory.innerHTML+=
      `<div class="meta">ğŸ“¦ ${k} â€” <b>${v.toLocaleString("ar-SA")} Ø±ÙŠØ§Ù„</b></div>`;
  });
}

function renderExpenses(){
  expensesList.innerHTML="";
  cache.forEach(e=>{
    expensesList.innerHTML+=`
      <div class="expense">
        <div class="top">
          <span>${e.amount} Ø±ÙŠØ§Ù„</span>
          <span>${e.categories?.name||""}</span>
        </div>
        <div class="meta">ğŸ“… ${e.expense_date}</div>
        ${e.vendor?`<div class="meta">ğŸ·ï¸ ${e.vendor}</div>`:""}
        ${e.description?`<div class="meta">ğŸ“ ${e.description}</div>`:""}
        <div class="actions">
          <button class="btn sm secondary" onclick="editExpense('${e.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn sm danger" onclick="deleteExpense('${e.id}')">Ø­Ø°Ù</button>
        </div>
      </div>`;
  });
}

/* ğŸ†• Category Details Logic */
function renderCategoryDetails(){
  const catId = categoryDetailsSelect.value;
  categoryExpensesList.innerHTML="";
  categoryTotal.style.display="none";
  if(!catId) return;

  const filtered = cache.filter(e => e.category_id === catId);
  if(!filtered.length){
    categoryExpensesList.innerHTML =
      `<div class="meta">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯.</div>`;
    return;
  }

  let total = 0;
  filtered.forEach(e=>{
    total += Number(e.amount||0);
    categoryExpensesList.innerHTML += `
      <div class="expense">
        <div class="top">
          <span>${e.amount} Ø±ÙŠØ§Ù„</span>
          <span>${e.expense_date}</span>
        </div>
        ${e.vendor?`<div class="meta">ğŸ·ï¸ ${e.vendor}</div>`:""}
        ${e.description?`<div class="meta">ğŸ“ ${e.description}</div>`:""}
      </div>
    `;
  });

  categoryTotalValue.textContent =
    total.toLocaleString("ar-SA") + " Ø±ÙŠØ§Ù„";
  categoryTotal.style.display="block";
}

function editExpense(id){
  const e=cache.find(x=>x.id===id);
  editingId=id;
  date.value=e.expense_date;
  categorySelect.value=e.category_id;
  amount.value=e.amount;
  vendor.value=e.vendor||"";
  description.value=e.description||"";
  toggleAccordion("secAddEdit");
}

expenseForm.onsubmit=async ev=>{
  ev.preventDefault();
  const payload={
    expense_date:date.value,
    category_id:categorySelect.value,
    amount:Number(amount.value),
    vendor:vendor.value,
    description:description.value
  };
  editingId
    ? await sb.from("expenses").update(payload).eq("id",editingId)
    : await sb.from("expenses").insert(payload);
  editingId=null;
  expenseForm.reset();
  date.value=new Date().toISOString().split("T")[0];
  loadExpenses();
};

async function deleteExpense(id){
  if(confirm("Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙØŸ")){
    await sb.from("expenses").delete().eq("id",id);
    loadExpenses();
  }
}

/* Excel Backup */
async function exportBackup(){
  const {data}=await sb.from("expenses")
    .select("expense_date,amount,vendor,description,categories(name)");
  const sheet=data.map(e=>({
    Ø§Ù„ØªØ§Ø±ÙŠØ®:e.expense_date,
    Ø§Ù„Ø¨Ù†Ø¯:e.categories?.name,
    Ø§Ù„Ù…Ø¨Ù„Øº:e.amount,
    Ø§Ù„Ù…ÙˆØ±Ø¯:e.vendor,
    Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:e.description
  }));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(sheet),"Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ");
  XLSX.writeFile(wb,"backup-building-expenses.xlsx");
}

/* INIT */
(function(){
  if(localStorage.getItem("theme")==="light")
    document.body.classList.add("light");
  const open=localStorage.getItem("openSection")||"secAddEdit";
  document.getElementById(open)?.classList.add("open");
  loadNotes();
  loadCategories();
  loadExpenses();
})();
</script>

</body>
</html>
