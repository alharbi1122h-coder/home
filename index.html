<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¨Ù†Ø§Ø¡</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg1:#111827;
  --bg2:#1f2937;

  --card:rgba(255,255,255,.14);
  --card2:rgba(255,255,255,.18);
  --border:rgba(255,255,255,.22);

  --text:#f9fafb;
  --muted:#cbd5e1;

  --primary:#60a5fa;
  --primary2:#3b82f6;
  --danger:#ef4444;
  --ok:#22c55e;

  --radius:18px;
  --shadow:0 18px 45px rgba(0,0,0,.35);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Tahoma,Arial;
  color:var(--text);
  background:
    radial-gradient(1200px 800px at 10% 10%, rgba(96,165,250,.18), transparent 70%),
    radial-gradient(1000px 700px at 90% 20%, rgba(34,197,94,.12), transparent 70%),
    linear-gradient(180deg,var(--bg1),var(--bg2));
}

.container{max-width:1200px;margin:auto;padding:18px}
.layout{display:grid;gap:16px}
@media(min-width:980px){.layout{grid-template-columns:360px 1fr}}

.card{
  background:linear-gradient(180deg,var(--card2),var(--card));
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:16px;
  backdrop-filter: blur(12px);
}

/* ===== Accordion iOS ===== */
.accordion .card-header{
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  gap:12px;
  padding:10px;
  border-radius:14px;
}
.accordion .card-header:active{
  transform:scale(.995);
}
.arrow{
  font-size:18px;
  transition:.25s;
}
.accordion.open .arrow{
  transform:rotate(180deg);
}
.accordion-content{
  max-height:0;
  overflow:hidden;
  opacity:0;
  transition:max-height .35s ease, opacity .25s ease;
}
.accordion.open .accordion-content{
  max-height:5000px;
  opacity:1;
}

/* ===== UI ===== */
.card-title{font-size:16px;font-weight:900}
.card-desc{font-size:12px;color:var(--muted);margin-top:4px}
.hr{height:1px;background:var(--border);margin:14px 0}

.input,select,textarea{
  width:100%;
  padding:14px;
  border-radius:16px;
  border:1px solid var(--border);
  background:rgba(0,0,0,.25);
  color:var(--text);
}
textarea{min-height:120px}
.label{font-size:12px;font-weight:900;margin:10px 0 6px}

.btn{
  border:none;
  border-radius:14px;
  padding:12px 14px;
  font-weight:900;
  cursor:pointer;
  color:#fff;
  background:linear-gradient(135deg,var(--primary),var(--primary2));
}
.btn.secondary{
  background:rgba(255,255,255,.18);
  color:#fff;
  border:1px solid var(--border);
}
.btn.danger{
  background:linear-gradient(135deg,#ef4444,#b91c1c);
}
.btn.sm{padding:10px 12px;font-size:13px}

.notice{
  margin-top:10px;
  padding:10px 12px;
  border-radius:14px;
  background:rgba(34,197,94,.18);
  font-size:12px;
  font-weight:800;
  display:none;
  justify-content:space-between;
}

.stat{
  padding:14px;
  border-radius:16px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.12);
}
.stat .k{font-size:12px;font-weight:900;color:var(--muted)}
.stat .v{font-size:22px;font-weight:1100}

.expense{
  border:1px solid var(--border);
  border-radius:16px;
  padding:14px;
  background:rgba(255,255,255,.1);
  margin-bottom:12px;
}
.actions{display:flex;gap:10px;margin-top:10px}
.actions .btn{flex:1}
</style>
</head>

<body>

<div class="container">
<div class="layout">

<!-- ===== SIDEBAR ===== -->
<div>

<div class="card accordion" id="secNotes">
  <div class="card-header" onclick="toggleAccordionById('secNotes')">
    <div>
      <div class="card-title">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
      <div class="card-desc">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©</div>
    </div>
    <div class="arrow">â¬‡ï¸</div>
  </div>
  <div class="accordion-content">
    <textarea id="projectNotes" class="input"></textarea>
    <div style="margin-top:10px;display:flex;gap:10px">
      <button class="btn sm" onclick="saveNotes()">ğŸ’¾ Ø­ÙØ¸</button>
      <button class="btn sm secondary" onclick="loadNotes()">â†» ØªØ­Ø¯ÙŠØ«</button>
    </div>
    <div id="notesStatus" class="notice">
      <span>ØªÙ… Ø§Ù„Ø­ÙØ¸</span><span id="notesStatusTime"></span>
    </div>
  </div>
</div>

<div style="height:14px"></div>

<div class="card accordion" id="secCats">
  <div class="card-header" onclick="toggleAccordionById('secCats')">
    <div>
      <div class="card-title">ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯</div>
      <div class="card-desc">Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø°Ù Ø§Ù„Ø¨Ù†ÙˆØ¯</div>
    </div>
    <div class="arrow">â¬‡ï¸</div>
  </div>
  <div class="accordion-content">
    <label class="label">Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</label>
    <input id="newCategoryName" class="input">
    <div style="margin-top:10px;display:flex;gap:10px">
      <button class="btn sm" onclick="addCategory()">â• Ø¥Ø¶Ø§ÙØ©</button>
      <button class="btn sm secondary" onclick="loadCategories()">â†» ØªØ­Ø¯ÙŠØ«</button>
    </div>
    <div class="hr"></div>
    <div id="categoriesList"></div>
  </div>
</div>

</div>

<!-- ===== MAIN ===== -->
<div>

<!-- ADD / EDIT (OPEN DEFAULT) -->
<div class="card accordion open" id="secAddEdit">
  <div class="card-header" onclick="toggleAccordionById('secAddEdit')">
    <div>
      <div class="card-title">â• Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…ØµØ±ÙˆÙ</div>
      <div class="card-desc">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</div>
    </div>
    <div class="arrow">â¬‡ï¸</div>
  </div>
  <div class="accordion-content">
    <form id="expenseForm">
      <label class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
      <input type="date" id="date" class="input">
      <label class="label">Ø§Ù„Ø¨Ù†Ø¯</label>
      <select id="categorySelect" class="input"></select>
      <label class="label">Ø§Ù„Ù…Ø¨Ù„Øº</label>
      <input type="number" id="amount" class="input">
      <label class="label">Ø§Ù„Ù…ÙˆØ±Ø¯</label>
      <input type="text" id="vendor" class="input">
      <label class="label">Ø§Ù„ÙˆØµÙ</label>
      <input type="text" id="description" class="input">
      <div style="margin-top:12px;display:flex;gap:10px">
        <button class="btn sm">ğŸ’¾ Ø­ÙØ¸</button>
        <button type="button" class="btn sm secondary" onclick="resetForm()">âœ– Ø¥Ù„ØºØ§Ø¡</button>
      </div>
      <div id="saveStatus" class="notice">
        <span id="saveStatusText"></span><span id="saveStatusTime"></span>
      </div>
    </form>
  </div>
</div>

<div style="height:14px"></div>

<div class="card accordion" id="secStats">
  <div class="card-header" onclick="toggleAccordionById('secStats')">
    <div>
      <div class="card-title">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
      <div class="card-desc">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ÙˆØ§Ù„Ù…Ù„Ø®Øµ</div>
    </div>
    <div class="arrow">â¬‡ï¸</div>
  </div>
  <div class="accordion-content">
    <div class="stat">
      <div class="k">ğŸ’° Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</div>
      <div class="v" id="totalAll">0 Ø±ÙŠØ§Ù„</div>
    </div>
    <div class="hr"></div>
    <div id="perCategory"></div>
    <button class="btn sm" style="margin-top:10px" onclick="exportBackup()">ğŸ“¥ Excel</button>
  </div>
</div>

<div style="height:14px"></div>

<div class="card accordion" id="secExpenses">
  <div class="card-header" onclick="toggleAccordionById('secExpenses')">
    <div>
      <div class="card-title">ğŸ“‹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
      <div class="card-desc">Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
    </div>
    <div class="arrow">â¬‡ï¸</div>
  </div>
  <div class="accordion-content">
    <div id="expensesList"></div>
  </div>
</div>

</div>
</div>
</div>

<script>
/* ===== Supabase ===== */
const sb = supabase.createClient(
  "https://iuqbkqxyjendpgtlvwem.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1cWJrcXh5amVuZHBndGx2d2VtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MjYyOTUsImV4cCI6MjA4MDQwMjI5NX0.puUnNqutG0IuyRwJ3m8d2g4i4RkSn4kJZODCu41aBBw"
);

let cache=[], editingId=null;

/* ===== iOS Accordion ===== */
function toggleAccordionById(id){
  document.querySelectorAll(".accordion").forEach(a=>{
    if(a.id!==id) a.classList.remove("open");
  });
  document.getElementById(id)?.classList.toggle("open");
}

/* ===== Helpers ===== */
date.value=new Date().toISOString().split("T")[0];
function now(){return new Date().toLocaleString("ar-SA")}
function show(el,t){el.style.display="flex";t.textContent=now();setTimeout(()=>el.style.display="none",2000)}

/* ===== Notes ===== */
async function loadNotes(){
  const {data}=await sb.from("project_notes").select("*").single();
  if(data) projectNotes.value=data.notes||"";
}
async function saveNotes(){
  await sb.from("project_notes").upsert({id:1,notes:projectNotes.value});
  show(notesStatus,notesStatusTime);
}

/* ===== Categories ===== */
async function loadCategories(){
  const {data}=await sb.from("categories").select("*").order("name");
  categorySelect.innerHTML=""; categoriesList.innerHTML="";
  data.forEach(c=>{
    categorySelect.add(new Option(c.name,c.id));
    categoriesList.innerHTML+=`
      <div style="display:flex;justify-content:space-between;margin-bottom:8px">
        <b>${c.name}</b>
        <button class="btn sm danger" onclick="deleteCategory('${c.id}')">Ø­Ø°Ù</button>
      </div>`;
  });
}
async function addCategory(){
  if(!newCategoryName.value) return;
  await sb.from("categories").insert({name:newCategoryName.value});
  newCategoryName.value=""; loadCategories();
}
async function deleteCategory(id){
  if(confirm("Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯ØŸ")){await sb.from("categories").delete().eq("id",id);loadCategories();}
}

/* ===== Expenses ===== */
async function loadExpenses(){
  const {data}=await sb.from("expenses").select("*,categories(name)").order("expense_date",{ascending:false});
  cache=data||[]; renderStats(); renderExpenses();
}
function renderStats(){
  let total=0, per={};
  cache.forEach(e=>{
    total+=Number(e.amount||0);
    const c=e.categories?.name||"ØºÙŠØ± Ù…ØµÙ†Ù";
    per[c]=(per[c]||0)+Number(e.amount||0);
  });
  totalAll.textContent=total.toLocaleString("ar-SA")+" Ø±ÙŠØ§Ù„";
  perCategory.innerHTML="";
  Object.entries(per).forEach(([k,v])=>{
    perCategory.innerHTML+=`<div>${k} â€” <b>${v.toLocaleString("ar-SA")} Ø±ÙŠØ§Ù„</b></div>`;
  });
}
function renderExpenses(){
  expensesList.innerHTML="";
  cache.forEach(e=>{
    expensesList.innerHTML+=`
      <div class="expense">
        <b>${e.amount} Ø±ÙŠØ§Ù„</b> â€” ${e.categories?.name||""}
        <div style="font-size:12px">${e.expense_date}</div>
        <div class="actions">
          <button class="btn secondary" onclick="editExpense('${e.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn danger" onclick="deleteExpense('${e.id}')">Ø­Ø°Ù</button>
        </div>
      </div>`;
  });
}
function editExpense(id){
  const e=cache.find(x=>x.id===id);
  editingId=id;
  date.value=e.expense_date;
  categorySelect.value=e.category_id;
  amount.value=e.amount;
  vendor.value=e.vendor||"";
  description.value=e.description||"";
  toggleAccordionById("secAddEdit");
}
expenseForm.onsubmit=async ev=>{
  ev.preventDefault();
  const p={expense_date:date.value,category_id:categorySelect.value,amount:Number(amount.value),vendor:vendor.value,description:description.value};
  editingId?await sb.from("expenses").update(p).eq("id",editingId):await sb.from("expenses").insert(p);
  editingId=null;expenseForm.reset();date.value=new Date().toISOString().split("T")[0];
  loadExpenses();
}
async function deleteExpense(id){
  if(confirm("Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙØŸ")){await sb.from("expenses").delete().eq("id",id);loadExpenses();}
}
function resetForm(){editingId=null;expenseForm.reset()}

/* ===== Excel ===== */
async function exportBackup(){
  const {data}=await sb.from("expenses").select("expense_date,amount,description,categories(name)");
  const sheet=data.map(e=>({Ø§Ù„ØªØ§Ø±ÙŠØ®:e.expense_date,Ø§Ù„Ø¨Ù†Ø¯:e.categories?.name,Ø§Ù„Ù…Ø¨Ù„Øº:e.amount,Ø§Ù„ÙˆØµÙ:e.description}));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(sheet),"Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ");
  XLSX.writeFile(wb,"expenses.xlsx");
}

/* Init */
loadNotes(); loadCategories(); loadExpenses();
</script>

</body>
</html>
