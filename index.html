
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¨Ù†Ø§Ø¡</title>

<!-- Supabase v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Excel (XLSX) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg1:#0b1220;
  --bg2:#0f172a;
  --card:rgba(255,255,255,.08);
  --card2:rgba(255,255,255,.10);
  --border:rgba(255,255,255,.12);
  --text:#e5e7eb;
  --muted:#a3a3a3;
  --primary:#4f8cff;
  --primary2:#2563eb;
  --danger:#ef4444;
  --ok:#22c55e;
  --shadow: 0 18px 45px rgba(0,0,0,.35);
  --radius:18px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,Tahoma,Arial;
  color:var(--text);
  background:
    radial-gradient(1200px 800px at 10% 10%, rgba(79,140,255,.28), transparent 55%),
    radial-gradient(900px 600px at 90% 20%, rgba(34,197,94,.16), transparent 55%),
    radial-gradient(1100px 700px at 50% 100%, rgba(239,68,68,.12), transparent 60%),
    linear-gradient(180deg, var(--bg1), var(--bg2));
}

a{color:inherit}
.container{
  max-width:1200px;
  margin:0 auto;
  padding:18px;
}

.topbar{
  position:sticky;
  top:0;
  z-index:10;
  backdrop-filter: blur(14px);
  background: linear-gradient(180deg, rgba(15,23,42,.85), rgba(15,23,42,.55));
  border-bottom:1px solid var(--border);
}
.topbar-inner{
  max-width:1200px;
  margin:0 auto;
  padding:14px 18px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.brand{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}
.logo{
  width:40px;height:40px;border-radius:14px;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 45%),
              linear-gradient(135deg, rgba(79,140,255,.95), rgba(37,99,235,.75));
  box-shadow: 0 10px 25px rgba(79,140,255,.25);
  display:grid;place-items:center;
  font-weight:900;
}
.brand h1{
  margin:0;
  font-size:18px;
  line-height:1.1;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.brand .sub{
  font-size:12px;
  color:rgba(229,231,235,.75);
  margin-top:2px;
}
.top-actions{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.pill{
  display:flex;align-items:center;gap:8px;
  padding:10px 12px;border-radius:999px;
  background:rgba(255,255,255,.08);
  border:1px solid var(--border);
  font-size:12px;
  color:rgba(229,231,235,.85);
}
.dot{
  width:8px;height:8px;border-radius:999px;background:var(--ok);
  box-shadow:0 0 0 4px rgba(34,197,94,.18);
}
.small-btn{
  border:1px solid var(--border);
  background:rgba(255,255,255,.08);
  color:var(--text);
  padding:10px 12px;
  border-radius:14px;
  font-weight:800;
  cursor:pointer;
}
.small-btn:hover{background:rgba(255,255,255,.11)}

.layout{
  display:grid;
  gap:16px;
  margin-top:16px;
}
@media(min-width:980px){
  .layout{
    grid-template-columns:360px 1fr;
    align-items:start;
  }
}

.card{
  background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
  border:1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding:16px;
}
.card-header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
  margin-bottom:12px;
}
.card-title{
  margin:0;
  font-size:16px;
  font-weight:1000;
  letter-spacing:.2px;
}
.card-desc{
  margin:6px 0 0;
  font-size:12px;
  color:rgba(229,231,235,.68);
  line-height:1.5;
}
.hr{
  height:1px;
  background:var(--border);
  margin:14px 0;
  border:none;
}

.grid2{
  display:grid;
  gap:12px;
}
@media(min-width:760px){
  .grid2{grid-template-columns:1fr 1fr}
}

.stat{
  padding:14px;
  border-radius:16px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.07);
}
.stat .k{font-size:12px;color:rgba(229,231,235,.72);font-weight:900;margin-bottom:8px}
.stat .v{font-size:22px;font-weight:1100;letter-spacing:.3px}
.stat .s{margin-top:6px;font-size:12px;color:rgba(229,231,235,.62);font-weight:700}

.percat{
  display:grid;
  gap:10px;
}
.row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.06);
}
.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  background:rgba(79,140,255,.18);
  border:1px solid rgba(79,140,255,.35);
  font-size:12px;
  font-weight:1000;
}
.badge .mini{
  width:8px;height:8px;border-radius:999px;background:rgba(79,140,255,.95);
  box-shadow:0 0 0 4px rgba(79,140,255,.14);
}

.btn{
  width:100%;
  border:none;
  border-radius:16px;
  padding:14px 14px;
  font-weight:1000;
  cursor:pointer;
  color:#fff;
  background: linear-gradient(135deg, rgba(79,140,255,.95), rgba(37,99,235,.82));
  box-shadow: 0 14px 30px rgba(79,140,255,.18);
}
.btn:hover{filter:brightness(1.04)}
.btn:active{transform:translateY(1px)}
.btn.secondary{
  background: rgba(255,255,255,.08);
  border:1px solid var(--border);
  color:var(--text);
  box-shadow:none;
}
.btn.danger{
  background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(185,28,28,.78));
  box-shadow: 0 14px 30px rgba(239,68,68,.16);
}
.btn.sm{
  padding:10px 12px;
  border-radius:14px;
  width:auto;
  font-size:13px;
}
.btn.inline{width:auto}

.input, select, textarea{
  width:100%;
  padding:14px 14px;
  border-radius:16px;
  border:1px solid var(--border);
  background:rgba(0,0,0,.18);
  color:var(--text);
  outline:none;
  font-size:15px;
}
select{cursor:pointer}
textarea{min-height:120px; resize:vertical}
.label{
  display:block;
  font-size:12px;
  font-weight:1000;
  color:rgba(229,231,235,.78);
  margin:10px 0 6px;
}

.notice{
  margin-top:10px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid var(--border);
  background: rgba(34,197,94,.12);
  color: rgba(229,231,235,.88);
  font-size:12px;
  font-weight:800;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.notice .muted{color:rgba(229,231,235,.62);font-weight:800}

.cat-add{
  padding:12px;
  border-radius:16px;
  border:1px dashed rgba(79,140,255,.45);
  background: rgba(79,140,255,.10);
}
.cat-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.06);
  margin-bottom:10px;
}
.cat-item .name{font-weight:1000}

.expense{
  padding:14px;
  border-radius:18px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.06);
  margin-bottom:12px;
}
.expense-top{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  margin-bottom:10px;
}
.amount{
  font-size:18px;
  font-weight:1100;
}
.meta{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin:8px 0 0;
  color:rgba(229,231,235,.72);
  font-size:12px;
  font-weight:800;
}
.actions{
  display:flex;
  gap:10px;
  margin-top:12px;
}
.actions .btn{flex:1}
@media(max-width:520px){
  .actions{flex-direction:column}
}

footer{
  margin:18px 0 30px;
  text-align:center;
  color:rgba(229,231,235,.45);
  font-size:12px;
  font-weight:700;
}
</style>
</head>

<body>
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="logo">ğŸ—ï¸</div>
      <div style="min-width:0">
        <h1>Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¨Ù†Ø§Ø¡</h1>
        <div class="sub">Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© + Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Excel</div>
      </div>
    </div>

    <div class="top-actions">
      <div class="pill"><span class="dot"></span> Ù…ØªØµÙ„</div>
      <button class="small-btn" onclick="exportBackup()">ğŸ“¥ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Excel</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="layout">

    <!-- Sidebar -->
    <div>

      <!-- Notes -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
            <div class="card-desc">Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø© (ØªÙØ­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª).</div>
          </div>
        </div>

        <textarea id="projectNotes" class="input" placeholder="Ù…Ø«Ø§Ù„: ØªÙ… ØµØ¨ Ø§Ù„Ø³Ù‚Ù Ø§Ù„ÙŠÙˆÙ…â€¦ / Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¯ÙØ¹Ø© Ù…Ø¹ Ø§Ù„Ù…ÙˆØ±Ø¯â€¦"></textarea>
        <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap">
          <button class="btn sm inline" onclick="saveNotes()">ğŸ’¾ Ø­ÙØ¸</button>
          <button class="btn sm inline secondary" onclick="loadNotes()">â†» ØªØ­Ø¯ÙŠØ«</button>
        </div>

        <div id="notesStatus" class="notice" style="display:none">
          <span>ØªÙ… Ø§Ù„Ø­ÙØ¸</span><span class="muted" id="notesStatusTime">â€”</span>
        </div>
      </div>

      <div style="height:14px"></div>

      <!-- Categories -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯</div>
            <div class="card-desc">Ø£Ø¶Ù Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø§Ø­Ø°Ù Ø¨Ù†Ø¯ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø±ØªØ¨Ø· Ø¨Ù…ØµØ§Ø±ÙŠÙ Ù„Ù† ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø­Ø°Ù).</div>
          </div>
        </div>

        <div class="cat-add">
          <label class="label">Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯</label>
          <input id="newCategoryName" class="input" placeholder="Ù…Ø«Ø§Ù„: Ø®Ø±Ø³Ø§Ù†Ø©ØŒ Ø³Ø¨Ø§ÙƒØ©ØŒ ÙƒÙ‡Ø±Ø¨Ø§Ø¡">
          <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap">
            <button class="btn sm inline" type="button" onclick="addCategory()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†Ø¯</button>
            <button class="btn sm inline secondary" type="button" onclick="loadCategories()">â†» ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
          </div>
        </div>

        <div class="hr"></div>
        <div id="categoriesList"></div>
      </div>

    </div>

    <!-- Main -->
    <div>

      <!-- Stats -->
      <div class="grid2">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</div>
              <div class="card-desc">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ ÙˆÙ…Ø¬Ù…ÙˆØ¹ ÙƒÙ„ Ø¨Ù†Ø¯ (ÙŠÙØ­Ø¯Ù‘Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹).</div>
            </div>
            <button class="btn sm inline secondary" onclick="loadExpenses()">â†» ØªØ­Ø¯ÙŠØ«</button>
          </div>

          <div class="grid2">
            <div class="stat">
              <div class="k">ğŸ’° Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</div>
              <div class="v" id="totalAll">0 Ø±ÙŠØ§Ù„</div>
              <div class="s" id="itemsCount">â€”</div>
            </div>

            <div class="stat">
              <div class="k">ğŸ“¥ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</div>
              <div class="v" style="font-size:14px; font-weight:1000; line-height:1.6">
                Ø­Ù…Ù‘Ù„ Ù…Ù„Ù Excel ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ + Ø§Ù„Ø¨Ù†ÙˆØ¯ + Ø§Ù„Ù…Ù„Ø®Øµ
              </div>
              <div style="margin-top:10px">
                <button class="btn sm inline" onclick="exportBackup()">ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø¢Ù†</button>
              </div>
            </div>
          </div>

          <div class="hr"></div>
          <div class="card-title" style="font-size:14px; margin-bottom:10px">ğŸ“¦ Ù…Ø¬Ù…ÙˆØ¹ ÙƒÙ„ Ø¨Ù†Ø¯</div>
          <div id="perCategory" class="percat"></div>
        </div>

        <!-- Add/Edit -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">â• Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…ØµØ±ÙˆÙ</div>
              <div class="card-desc">Ø£Ø¶Ù Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø¹Ø¯Ù‘Ù„ Ù…ØµØ±ÙˆÙ Ù…ÙˆØ¬ÙˆØ¯ (ÙŠÙØ­ÙØ¸ Ù…Ø¨Ø§Ø´Ø±Ø©).</div>
            </div>
            <button class="btn sm inline danger" onclick="resetForm()">âœ– Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
          </div>

          <form id="expenseForm">
            <label class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="date" class="input" required>

            <label class="label">Ø§Ù„Ø¨Ù†Ø¯</label>
            <select id="categorySelect" class="input" required></select>

            <div class="grid2">
              <div>
                <label class="label">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                <input type="number" id="amount" class="input" required placeholder="Ù…Ø«Ø§Ù„: 1200">
              </div>
              <div>
                <label class="label">Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                <input type="text" id="vendor" class="input" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¤Ø³Ø³Ø© ÙÙ„Ø§Ù†">
              </div>
            </div>

            <label class="label">Ø§Ù„ÙˆØµÙ</label>
            <input type="text" id="description" class="input" placeholder="Ù…Ø«Ø§Ù„: ØµØ¨Ø© Ø®Ø±Ø³Ø§Ù†Ø© Ù„Ù„Ø¯ÙˆØ± Ø§Ù„Ø£Ø±Ø¶ÙŠ">

            <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap">
              <button class="btn sm inline" type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
              <button class="btn sm inline secondary" type="button" onclick="scrollToExpenses()">â¬‡ï¸ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</button>
            </div>

            <div id="saveStatus" class="notice" style="display:none; background: rgba(79,140,255,.12)">
              <span id="saveStatusText">ØªÙ… Ø§Ù„Ø­ÙØ¸</span><span class="muted" id="saveStatusTime">â€”</span>
            </div>
          </form>
        </div>
      </div>

      <div style="height:16px"></div>

      <!-- Expenses list -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">ğŸ“‹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
            <div class="card-desc">Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ÙƒØ¨Ø·Ø§Ù‚Ø§Øª Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø¬ÙˆØ§Ù„ Ù…Ø¹ Ø£Ø²Ø±Ø§Ø± ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù.</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn sm inline secondary" onclick="loadExpenses()">â†» ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn sm inline" onclick="exportBackup()">ğŸ“¥ Excel</button>
          </div>
        </div>

        <div id="expensesList"></div>
      </div>

      <footer>Â© Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¨Ù†Ø§Ø¡ â€” Ù†Ø³Ø®Ø© Ø¨Ø³ÙŠØ·Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ·ÙˆÙŠØ±</footer>
    </div>

  </div>
</div>

<script>
/* ===== Supabase ===== */
const SUPABASE_URL="https://iuqbkqxyjendpgtlvwem.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFub24iLCJpYXQiOjE3NjQ4MjYyOTUsImV4cCI6MjA4MDQwMjI5NX0.puUnNqutG0IuyRwJ3m8d2g4i4RkSn4kJZODCu41aBBw";

 
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let cache = [];
let editingId = null;

/* ===== Helpers ===== */
function todayISO(){ return new Date().toISOString().split("T")[0]; }
function nowTime(){
  const d = new Date();
  return d.toLocaleString("ar-SA", { hour12:true });
}
function fmtSAR(n){
  const x = Number(n || 0);
  return x.toLocaleString("ar-SA") + " Ø±ÙŠØ§Ù„";
}
function showNotice(el, timeEl){
  el.style.display = "flex";
  timeEl.textContent = nowTime();
  setTimeout(()=>{ el.style.display = "none"; }, 2200);
}
function scrollToExpenses(){
  document.getElementById("expensesList").scrollIntoView({behavior:"smooth", block:"start"});
}
function resetForm(){
  editingId = null;
  expenseForm.reset();
  date.value = todayISO();
  saveStatus.style.display="none";
}

/* ===== Notes ===== */
async function loadNotes(){
  const { data, error } = await sb.from("project_notes").select("*").limit(1).single();
  if(error){ console.error(error); return; }
  if(data) projectNotes.value = data.notes || "";
}
async function saveNotes(){
  const { error } = await sb.from("project_notes").upsert({ id:1, notes: projectNotes.value });
  if(error){ console.error(error); alert("ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª"); return; }
  showNotice(notesStatus, notesStatusTime);
}

/* ===== Categories ===== */
async function loadCategories(){
  const { data, error } = await sb.from("categories").select("*").order("name");
  if(error){ console.error(error); return; }

  categorySelect.innerHTML = "";
  categoriesList.innerHTML = "";

  data.forEach(c=>{
    categorySelect.add(new Option(c.name, c.id));
    categoriesList.innerHTML += `
      <div class="cat-item">
        <div class="name">ğŸ“Œ ${escapeHtml(c.name)}</div>
        <button class="btn sm inline danger" onclick="deleteCategory('${c.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div>
    `;
  });

  // Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠÙ‡ Ø¨Ù†ÙˆØ¯
  if(!data.length){
    categoriesList.innerHTML = `<div style="color:rgba(229,231,235,.65);font-weight:800;font-size:13px">
      Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯â€¦ Ø£Ø¶Ù Ø¨Ù†Ø¯ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰.
    </div>`;
  }
}

async function addCategory(){
  const name = (newCategoryName.value || "").trim();
  if(!name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯");

  const { error } = await sb.from("categories").insert({ name });
  if(error){
    console.error(error);
    return alert("ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†Ø¯ (Ø±Ø¨Ù…Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹)");
  }

  newCategoryName.value = "";
  await loadCategories();
}

async function deleteCategory(id){
  if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯ØŸ")) return;
  const { error } = await sb.from("categories").delete().eq("id", id);
  if(error){
    console.error(error);
    return alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¨Ù†Ø¯ Ù…Ø±ØªØ¨Ø· Ø¨Ù…ØµØ§Ø±ÙŠÙ");
  }
  await loadCategories();
}

/* ===== Stats ===== */
function renderStats(){
  const total = cache.reduce((s,e)=> s + Number(e.amount || 0), 0);
  totalAll.textContent = fmtSAR(total);
  itemsCount.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: ${cache.length}`;

  const per = {};
  cache.forEach(e=>{
    const cat = e.categories?.name || "ØºÙŠØ± Ù…ØµÙ†Ù";
    per[cat] = (per[cat] || 0) + Number(e.amount || 0);
  });

  const rows = Object.entries(per).sort((a,b)=> b[1]-a[1]);

  perCategory.innerHTML = "";
  if(!rows.length){
    perCategory.innerHTML = `<div style="color:rgba(229,231,235,.65);font-weight:900;font-size:13px">
      Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.
    </div>`;
    return;
  }

  rows.forEach(([name,sum])=>{
    perCategory.innerHTML += `
      <div class="row">
        <span class="badge"><span class="mini"></span>${escapeHtml(name)}</span>
        <b style="font-weight:1100">${fmtSAR(sum)}</b>
      </div>
    `;
  });
}

/* ===== Expenses ===== */
async function loadExpenses(){
  const { data, error } = await sb
    .from("expenses")
    .select("*,categories(name)")
    .order("expense_date", { ascending:false });

  if(error){ console.error(error); alert("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ"); return; }

  cache = data || [];
  renderStats();
  renderExpensesList();
}

function renderExpensesList(){
  expensesList.innerHTML = "";

  if(!cache.length){
    expensesList.innerHTML = `<div style="color:rgba(229,231,235,.65);font-weight:900;font-size:13px">
      Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙâ€¦ Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ù…ØµØ±ÙˆÙ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰.
    </div>`;
    return;
  }

  cache.forEach(e=>{
    expensesList.innerHTML += `
      <div class="expense">
        <div class="expense-top">
          <div class="amount">${fmtSAR(e.amount)}</div>
          <div class="badge"><span class="mini"></span>${escapeHtml(e.categories?.name || "")}</div>
        </div>

        <div class="meta">
          <span>ğŸ“… ${escapeHtml(e.expense_date || "")}</span>
          ${e.vendor ? `<span>ğŸ·ï¸ ${escapeHtml(e.vendor)}</span>` : ``}
        </div>

        ${e.description ? `<div style="margin-top:10px;color:rgba(229,231,235,.8);font-weight:800">
          ${escapeHtml(e.description)}
        </div>` : ``}

        <div class="actions">
          <button class="btn secondary" onclick="editExpense('${e.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn danger" onclick="deleteExpense('${e.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </div>
      </div>
    `;
  });
}

function editExpense(id){
  const e = cache.find(x=>x.id===id);
  if(!e) return;
  editingId = id;
  date.value = e.expense_date || todayISO();
  categorySelect.value = e.category_id;
  amount.value = e.amount;
  vendor.value = e.vendor || "";
  description.value = e.description || "";

  saveStatusText.textContent = "ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…ÙØ¹Ù„ â€” Ø§Ø­ÙØ¸ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ±ÙˆÙ";
  saveStatus.style.display = "flex";
  saveStatusTime.textContent = nowTime();

  window.scrollTo({ top: 0, behavior: "smooth" });
}

expenseForm.addEventListener("submit", async (ev)=>{
  ev.preventDefault();

  const payload = {
    expense_date: date.value,
    category_id: categorySelect.value,
    amount: Number(amount.value),
    vendor: vendor.value,
    description: description.value
  };

  let error = null;

  if(editingId){
    ({ error } = await sb.from("expenses").update(payload).eq("id", editingId));
  } else {
    ({ error } = await sb.from("expenses").insert(payload));
  }

  if(error){
    console.error(error);
    alert("ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸");
    return;
  }

  saveStatusText.textContent = editingId ? "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ±ÙˆÙ" : "âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ";
  showNotice(saveStatus, saveStatusTime);

  editingId = null;
  expenseForm.reset();
  date.value = todayISO();
  await loadExpenses();
});

async function deleteExpense(id){
  if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙØŸ")) return;
  const { error } = await sb.from("expenses").delete().eq("id", id);
  if(error){
    console.error(error);
    alert("ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ");
    return;
  }
  await loadExpenses();
}

/* ===== Excel Backup (3 Sheets) ===== */
async function exportBackup(){
  // Ø¬Ù„Ø¨ Ø´Ø§Ù…Ù„ ÙˆÙ…ÙØ±ØªÙ‘Ø¨ (Ø­ØªÙ‰ Ù„Ùˆ cache Ù‚Ø¯ÙŠÙ…Ø©)
  const { data: expenses, error: eErr } = await sb
    .from("expenses")
    .select("expense_date, amount, vendor, description, categories(name)")
    .order("expense_date", { ascending:true });

  if(eErr){ console.error(eErr); return alert("ØªØ¹Ø°Ø± ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©"); }

  const { data: categories, error: cErr } = await sb
    .from("categories")
    .select("name")
    .order("name");

  if(cErr){ console.error(cErr); return alert("ØªØ¹Ø°Ø± ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù„Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©"); }

  // Sheet 1: Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ
  const expensesSheet = (expenses || []).map(e=>({
    Ø§Ù„ØªØ§Ø±ÙŠØ®: e.expense_date,
    Ø§Ù„Ø¨Ù†Ø¯: e.categories?.name || "",
    Ø§Ù„Ù…Ø¨Ù„Øº: e.amount,
    Ø§Ù„Ù…ÙˆØ±Ø¯: e.vendor || "",
    Ø§Ù„ÙˆØµÙ: e.description || ""
  }));

  // Sheet 2: Ø§Ù„Ø¨Ù†ÙˆØ¯
  const categoriesSheet = (categories || []).map(c=>({ Ø§Ù„Ø¨Ù†Ø¯: c.name }));

  // Sheet 3: Ø§Ù„Ù…Ù„Ø®Øµ
  const summary = {};
  let total = 0;
  (expenses || []).forEach(e=>{
    const cat = e.categories?.name || "ØºÙŠØ± Ù…ØµÙ†Ù";
    total += Number(e.amount || 0);
    summary[cat] = (summary[cat] || 0) + Number(e.amount || 0);
  });

  const summarySheet = [{ Ø§Ù„Ø¨ÙŠØ§Ù†: "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ", Ø§Ù„Ù‚ÙŠÙ…Ø©: total }];
  Object.entries(summary)
    .sort((a,b)=> b[1]-a[1])
    .forEach(([k,v])=> summarySheet.push({ Ø§Ù„Ø¨ÙŠØ§Ù†: k, Ø§Ù„Ù‚ÙŠÙ…Ø©: v }));

  // Ø¨Ù†Ø§Ø¡ Excel
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(expensesSheet), "Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(categoriesSheet), "Ø§Ù„Ø¨Ù†ÙˆØ¯");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summarySheet), "Ø§Ù„Ù…Ù„Ø®Øµ");

  const today = todayISO();
  XLSX.writeFile(wb, `backup-building-expenses-${today}.xlsx`);
}

/* ===== Security: prevent HTML injection in UI ===== */
function escapeHtml(str){
  const s = String(str ?? "");
  return s
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ===== Init ===== */
document.addEventListener("DOMContentLoaded", async ()=>{
  date.value = todayISO();
  await loadNotes();
  await loadCategories();
  await loadExpenses();
});
</script>

</body>
</html>
