<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¨Ù†Ø§Ø¡</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg1:#0b1220;
  --bg2:#0f172a;
  --card:rgba(255,255,255,.08);
  --border:rgba(255,255,255,.12);
  --text:#e5e7eb;
  --muted:#a3a3a3;
  --primary:#4f8cff;
  --danger:#ef4444;
  --ok:#22c55e;
  --shadow:0 18px 45px rgba(0,0,0,.35);
  --radius:18px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Tahoma,Arial;
  color:var(--text);
  background:
    radial-gradient(1400px 900px at 10% 10%, rgba(79,140,255,.12), transparent 70%),
    radial-gradient(1000px 700px at 90% 20%, rgba(34,197,94,.08), transparent 70%),
    linear-gradient(180deg,var(--bg1),var(--bg2));
}
.container{max-width:1200px;margin:auto;padding:18px}
.layout{display:grid;gap:16px}
@media(min-width:980px){.layout{grid-template-columns:360px 1fr}}

.card{
  background:linear-gradient(180deg,rgba(255,255,255,.1),rgba(255,255,255,.05));
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:16px;
}

/* Accordion */
.accordion-header{
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.accordion-header:hover{opacity:.9}
.arrow{transition:.3s;font-size:18px}
.accordion.open .arrow{transform:rotate(180deg)}
.accordion-content{
  max-height:0;
  overflow:hidden;
  opacity:0;
  transition:max-height .4s ease, opacity .3s ease;
}
.accordion.open .accordion-content{
  max-height:3000px;
  opacity:1;
}

.card-title{font-size:16px;font-weight:900}
.card-desc{font-size:12px;color:rgba(229,231,235,.65);margin-top:4px}
.hr{height:1px;background:var(--border);margin:14px 0}

.input,select,textarea{
  width:100%;
  padding:14px;
  border-radius:16px;
  border:1px solid var(--border);
  background:rgba(0,0,0,.2);
  color:var(--text);
}
.label{font-size:12px;font-weight:900;margin:10px 0 6px}
textarea{min-height:110px}

.btn{
  border:none;
  border-radius:14px;
  padding:12px 14px;
  font-weight:900;
  cursor:pointer;
  color:#fff;
  background:linear-gradient(135deg,#4f8cff,#2563eb);
}
.btn.secondary{background:rgba(255,255,255,.08);color:var(--text);border:1px solid var(--border)}
.btn.danger{background:linear-gradient(135deg,#ef4444,#b91c1c)}
.btn.sm{padding:10px 12px;font-size:13px}

.notice{
  margin-top:10px;
  padding:10px 12px;
  border-radius:14px;
  background:rgba(34,197,94,.12);
  font-size:12px;
  font-weight:800;
  display:none;
  justify-content:space-between;
}

.expense{border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:12px;background:rgba(255,255,255,.05)}
.actions{display:flex;gap:10px;margin-top:10px}
.actions .btn{flex:1}
</style>
</head>

<body>

<div class="container">
<div class="layout">

<!-- ===== Sidebar ===== -->
<div>

<!-- Notes -->
<div class="card accordion">
  <div class="accordion-header" onclick="this.parentElement.classList.toggle('open')">
    <div>
      <div class="card-title">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
      <div class="card-desc">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø© Ù…Ø­ÙÙˆØ¸Ø©</div>
    </div>
    <div class="arrow">â¬‡ï¸</div>
  </div>
  <div class="accordion-content">
    <textarea id="projectNotes" class="input"></textarea>
    <div style="margin-top:10px;display:flex;gap:10px">
      <button class="btn sm" onclick="saveNotes()">ğŸ’¾ Ø­ÙØ¸</button>
      <button class="btn sm secondary" onclick="loadNotes()">â†» ØªØ­Ø¯ÙŠØ«</button>
    </div>
    <div id="notesStatus" class="notice">
      <span>ØªÙ… Ø§Ù„Ø­ÙØ¸</span><span id="notesStatusTime"></span>
    </div>
  </div>
</div>

<div style="height:14px"></div>

<!-- Categories -->
<div class="card accordion">
  <div class="accordion-header" onclick="this.parentElement.classList.toggle('open')">
    <div>
      <div class="card-title">ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯</div>
      <div class="card-desc">Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø°Ù Ø§Ù„Ø¨Ù†ÙˆØ¯</div>
    </div>
    <div class="arrow">â¬‡ï¸</div>
  </div>
  <div class="accordion-content">
    <label class="label">Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</label>
    <input id="newCategoryName" class="input">
    <div style="margin-top:10px;display:flex;gap:10px">
      <button class="btn sm" onclick="addCategory()">â• Ø¥Ø¶Ø§ÙØ©</button>
      <button class="btn sm secondary" onclick="loadCategories()">â†» ØªØ­Ø¯ÙŠØ«</button>
    </div>
    <div class="hr"></div>
    <div id="categoriesList"></div>
  </div>
</div>

</div>

<!-- ===== Main ===== -->
<div>

<!-- Add/Edit Expense (OPEN by default) -->
<div class="card accordion open">
  <div class="accordion-header" onclick="this.parentElement.classList.toggle('open')">
    <div>
      <div class="card-title">â• Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…ØµØ±ÙˆÙ</div>
      <div class="card-desc">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</div>
    </div>
    <div class="arrow">â¬‡ï¸</div>
  </div>

  <div class="accordion-content">
    <form id="expenseForm">
      <label class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
      <input type="date" id="date" class="input">

      <label class="label">Ø§Ù„Ø¨Ù†Ø¯</label>
      <select id="categorySelect" class="input"></select>

      <label class="label">Ø§Ù„Ù…Ø¨Ù„Øº</label>
      <input type="number" id="amount" class="input">

      <label class="label">Ø§Ù„Ù…ÙˆØ±Ø¯</label>
      <input type="text" id="vendor" class="input">

      <label class="label">Ø§Ù„ÙˆØµÙ</label>
      <input type="text" id="description" class="input">

      <div style="margin-top:12px;display:flex;gap:10px">
        <button class="btn sm">ğŸ’¾ Ø­ÙØ¸</button>
        <button type="button" class="btn sm secondary" onclick="resetForm()">âœ– Ø¥Ù„ØºØ§Ø¡</button>
      </div>

      <div id="saveStatus" class="notice">
        <span id="saveStatusText"></span><span id="saveStatusTime"></span>
      </div>
    </form>
  </div>
</div>

<div style="height:16px"></div>

<!-- Expenses -->
<div class="card">
  <div class="card-title">ğŸ“‹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
  <div id="expensesList" style="margin-top:12px"></div>
</div>

</div>
</div>
</div>

<script>
/* === Supabase config === */
const sb = supabase.createClient(
  "https://iuqbkqxyjendpgtlvwem.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1cWJrcXh5amVuZHBndGx2d2VtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MjYyOTUsImV4cCI6MjA4MDQwMjI5NX0.puUnNqutG0IuyRwJ3m8d2g4i4RkSn4kJZODCu41aBBw"
);

let cache=[], editingId=null;
date.value = new Date().toISOString().split("T")[0];

function now(){return new Date().toLocaleString("ar-SA")}
function show(el,t){el.style.display="flex";t.textContent=now();setTimeout(()=>el.style.display="none",2000)}

/* Notes */
async function loadNotes(){
  const {data}=await sb.from("project_notes").select("*").single();
  if(data) projectNotes.value=data.notes||"";
}
async function saveNotes(){
  await sb.from("project_notes").upsert({id:1,notes:projectNotes.value});
  show(notesStatus,notesStatusTime);
}

/* Categories */
async function loadCategories(){
  const {data}=await sb.from("categories").select("*").order("name");
  categorySelect.innerHTML=""; categoriesList.innerHTML="";
  data.forEach(c=>{
    categorySelect.add(new Option(c.name,c.id));
    categoriesList.innerHTML+=`
      <div style="display:flex;justify-content:space-between;margin-bottom:8px">
        <b>${c.name}</b>
        <button class="btn sm danger" onclick="deleteCategory('${c.id}')">Ø­Ø°Ù</button>
      </div>`;
  });
}
async function addCategory(){
  if(!newCategoryName.value) return;
  await sb.from("categories").insert({name:newCategoryName.value});
  newCategoryName.value=""; loadCategories();
}
async function deleteCategory(id){
  if(confirm("Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯ØŸ")){await sb.from("categories").delete().eq("id",id);loadCategories();}
}

/* Expenses */
async function loadExpenses(){
  const {data}=await sb.from("expenses").select("*,categories(name)").order("expense_date",{ascending:false});
  cache=data||[]; renderExpenses();
}
function renderExpenses(){
  expensesList.innerHTML="";
  cache.forEach(e=>{
    expensesList.innerHTML+=`
    <div class="expense">
      <b>${e.amount} Ø±ÙŠØ§Ù„</b> â€” ${e.categories?.name||""}
      <div style="font-size:12px;margin-top:6px">${e.expense_date}</div>
      <div class="actions">
        <button class="btn secondary" onclick="editExpense('${e.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn danger" onclick="deleteExpense('${e.id}')">Ø­Ø°Ù</button>
      </div>
    </div>`;
  });
}
function editExpense(id){
  const e=cache.find(x=>x.id===id);
  editingId=id;
  date.value=e.expense_date;
  categorySelect.value=e.category_id;
  amount.value=e.amount;
  vendor.value=e.vendor||"";
  description.value=e.description||"";
}
expenseForm.onsubmit=async e=>{
  e.preventDefault();
  const payload={
    expense_date:date.value,
    category_id:categorySelect.value,
    amount:Number(amount.value),
    vendor:vendor.value,
    description:description.value
  };
  editingId
    ? await sb.from("expenses").update(payload).eq("id",editingId)
    : await sb.from("expenses").insert(payload);
  editingId=null; expenseForm.reset(); date.value=new Date().toISOString().split("T")[0];
  loadExpenses();
}
async function deleteExpense(id){
  if(confirm("Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙØŸ")){await sb.from("expenses").delete().eq("id",id);loadExpenses();}
}
function resetForm(){editingId=null;expenseForm.reset()}

/* Init */
loadNotes(); loadCategories(); loadExpenses();
</script>

</body>
</html>

