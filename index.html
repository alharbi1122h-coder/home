<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¨Ù†Ø§Ø¡</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
/* ================= THEME ================= */
:root{
  --bg1:#111827; --bg2:#1f2937;
  --card:#ffffff22; --border:#ffffff33;
  --text:#f9fafb; --muted:#cbd5e1;
  --primary:#60a5fa; --primary2:#3b82f6;
  --danger:#ef4444; --ok:#22c55e;
  --radius:18px;
}
.light{
  --bg1:#f8fafc; --bg2:#e5e7eb;
  --card:#00000010; --border:#00000022;
  --text:#0f172a; --muted:#475569;
}

*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,Tahoma,Arial;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  color:var(--text);
}
.container{max-width:1200px;margin:auto;padding:18px}
.layout{display:grid;gap:16px}
@media(min-width:980px){.layout{grid-template-columns:360px 1fr}}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
  backdrop-filter:blur(12px);
}

/* ========== ACCORDION IOS ========== */
.accordion .card-header{
  display:flex;justify-content:space-between;cursor:pointer;
}
.arrow{transition:.25s}
.accordion.open .arrow{transform:rotate(180deg)}
.accordion-content{
  max-height:0;overflow:hidden;opacity:0;
  transition:.35s;
}
.accordion.open .accordion-content{
  max-height:6000px;opacity:1;
}

/* ========== UI ========== */
.card-title{font-weight:900}
.card-desc{font-size:12px;color:var(--muted)}
.hr{height:1px;background:var(--border);margin:14px 0}
.input,select{
  width:100%;padding:14px;border-radius:14px;
  border:1px solid var(--border);
  background:transparent;color:var(--text);
}
.label{font-size:12px;font-weight:800;margin:8px 0 6px}
.btn{
  padding:12px 14px;border:none;border-radius:14px;
  font-weight:800;cursor:pointer;
  background:linear-gradient(135deg,var(--primary),var(--primary2));
  color:#fff;
}
.btn.secondary{background:transparent;border:1px solid var(--border)}
.btn.danger{background:linear-gradient(135deg,#ef4444,#b91c1c)}
.btn.sm{padding:10px;font-size:13px}

/* ===== Focus Mode ===== */
.focus .accordion:not(#secAddEdit){display:none}

/* ===== Chart ===== */
canvas{width:100%;max-height:260px}
</style>
</head>

<body>
<div class="container">

<!-- ACTION BAR -->
<div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap">
  <button class="btn sm secondary" onclick="toggleTheme()">ğŸŒ— Ù†Ù‡Ø§Ø± / Ù„ÙŠÙ„</button>
  <button class="btn sm secondary" onclick="toggleFocus()">ğŸ‘ï¸â€ğŸ—¨ï¸ ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ²</button>
</div>

<div class="layout">

<!-- SIDEBAR -->
<div>

<div class="card accordion" id="secNotes">
  <div class="card-header" onclick="toggleAccordion('secNotes')">
    <div>
      <div class="card-title">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
      <div class="card-desc">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
    </div><div class="arrow">â¬‡ï¸</div>
  </div>
  <div class="accordion-content">
    <textarea id="projectNotes" class="input"></textarea>
    <button class="btn sm" onclick="saveNotes()">ğŸ’¾ Ø­ÙØ¸</button>
  </div>
</div>

<div style="height:12px"></div>

<div class="card accordion" id="secCats">
  <div class="card-header" onclick="toggleAccordion('secCats')">
    <div>
      <div class="card-title">ğŸ“¦ Ø§Ù„Ø¨Ù†ÙˆØ¯</div>
      <div class="card-desc">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯</div>
    </div><div class="arrow">â¬‡ï¸</div>
  </div>
  <div class="accordion-content">
    <input id="newCategoryName" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯">
    <button class="btn sm" onclick="addCategory()">â• Ø¥Ø¶Ø§ÙØ©</button>
    <div class="hr"></div>
    <div id="categoriesList"></div>
  </div>
</div>

</div>

<!-- MAIN -->
<div>

<div class="card accordion open" id="secAddEdit">
  <div class="card-header" onclick="toggleAccordion('secAddEdit')">
    <div>
      <div class="card-title">â• Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</div>
      <div class="card-desc">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</div>
    </div><div class="arrow">â¬‡ï¸</div>
  </div>
  <div class="accordion-content">
    <form id="expenseForm">
      <label class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
      <input type="date" id="date" class="input">
      <label class="label">Ø§Ù„Ø¨Ù†Ø¯</label>
      <select id="categorySelect" class="input"></select>
      <label class="label">Ø§Ù„Ù…Ø¨Ù„Øº</label>
      <input type="number" id="amount" class="input">
      <button class="btn sm">ğŸ’¾ Ø­ÙØ¸</button>
    </form>
  </div>
</div>

<div style="height:12px"></div>

<div class="card accordion" id="secChart">
  <div class="card-header" onclick="toggleAccordion('secChart')">
    <div>
      <div class="card-title">ğŸ“Š Ø±Ø³Ù… Ø´Ù‡Ø±ÙŠ</div>
      <div class="card-desc">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
    </div><div class="arrow">â¬‡ï¸</div>
  </div>
  <div class="accordion-content">
    <canvas id="chart"></canvas>
  </div>
</div>

<div style="height:12px"></div>

<div class="card accordion" id="secExpenses">
  <div class="card-header" onclick="toggleAccordion('secExpenses')">
    <div>
      <div class="card-title">ğŸ“‹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
      <div class="card-desc">Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
    </div><div class="arrow">â¬‡ï¸</div>
  </div>
  <div class="accordion-content">
    <div id="expensesList"></div>
  </div>
</div>

</div>
</div>
</div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://iuqbkqxyjendpgtlvwem.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1cWJrcXh5amVuZHBndGx2d2VtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MjYyOTUsImV4cCI6MjA4MDQwMjI5NX0.puUnNqutG0IuyRwJ3m8d2g4i4RkSn4kJZODCu41aBBw"
);

let cache=[];

/* ========== IOS ACCORDION + SAVE STATE ========== */
function toggleAccordion(id){
  document.querySelectorAll(".accordion").forEach(a=>{
    if(a.id!==id) a.classList.remove("open");
  });
  const el=document.getElementById(id);
  el.classList.toggle("open");
  localStorage.setItem("openSection", id);
}

/* ========== THEME ========== */
function toggleTheme(){
  document.body.classList.toggle("light");
  localStorage.setItem("theme",
    document.body.classList.contains("light")?"light":"dark");
}

/* ========== FOCUS MODE ========== */
function toggleFocus(){
  document.body.classList.toggle("focus");
}

/* ========== DATA ========== */
date.value=new Date().toISOString().split("T")[0];

async function loadCategories(){
  const {data}=await sb.from("categories").select("*").order("name");
  categorySelect.innerHTML="";
  categoriesList.innerHTML="";
  data.forEach(c=>{
    categorySelect.add(new Option(c.name,c.id));
    categoriesList.innerHTML+=`<div>${c.name}</div>`;
  });
}

async function addCategory(){
  if(!newCategoryName.value) return;
  await sb.from("categories").insert({name:newCategoryName.value});
  newCategoryName.value="";
  loadCategories();
}

async function loadExpenses(){
  const {data}=await sb.from("expenses")
    .select("expense_date,amount,categories(name)")
    .order("expense_date");
  cache=data||[];
  renderExpenses();
  drawChart();
}

function renderExpenses(){
  expensesList.innerHTML="";
  cache.forEach(e=>{
    expensesList.innerHTML+=`<div>${e.expense_date} â€” ${e.amount} Ø±ÙŠØ§Ù„</div>`;
  });
}

expenseForm.onsubmit=async e=>{
  e.preventDefault();
  await sb.from("expenses").insert({
    expense_date:date.value,
    category_id:categorySelect.value,
    amount:Number(amount.value)
  });
  expenseForm.reset();date.value=new Date().toISOString().split("T")[0];
  loadExpenses();
};

/* ========== CHART ========== */
function drawChart(){
  const ctx=document.getElementById("chart").getContext("2d");
  ctx.clearRect(0,0,400,300);
  const months={};
  cache.forEach(e=>{
    const m=e.expense_date.slice(0,7);
    months[m]=(months[m]||0)+Number(e.amount);
  });
  const keys=Object.keys(months);
  const max=Math.max(...Object.values(months),1);
  keys.forEach((k,i)=>{
    const h=(months[k]/max)*200;
    ctx.fillStyle="#60a5fa";
    ctx.fillRect(40+i*60,240-h,30,h);
    ctx.fillText(k,40+i*60,260);
  });
}

/* INIT */
(function(){
  const t=localStorage.getItem("theme");
  if(t==="light") document.body.classList.add("light");

  const open=localStorage.getItem("openSection")||"secAddEdit";
  document.getElementById(open)?.classList.add("open");

  loadCategories();
  loadExpenses();
})();
</script>

</body>
</html>
